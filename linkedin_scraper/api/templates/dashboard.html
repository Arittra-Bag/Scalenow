{% extends "base.html" %}

{% block title %}Dashboard - LinkedIn Knowledge AI{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-5">
    <div>
        <h1 class="h2 mb-2 d-flex align-items-center">
            <i data-lucide="zap" class="me-3 text-warning"></i>
            <span class="gradient-text">AI Dashboard</span>
        </h1>
        <p class="text-secondary mb-0">Real-time knowledge extraction and processing</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-primary" onclick="showAddUrlModal()">
            <i data-lucide="plus" class="me-2"></i>Add URL
        </button>
        <a href="/upload" class="btn btn-outline-primary">
            <i data-lucide="upload" class="me-2"></i>Batch Upload
        </a>
        <button class="btn btn-success" onclick="startProcessing()">
            <i data-lucide="play" class="me-2"></i>Start Processing
        </button>
    </div>
</div>

<!-- Metrics Cards -->
<div class="row mb-5 g-4">
    <div class="col-md-3">
        <div class="metric-card" data-metric="total">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="metric-icon">
                    <i data-lucide="layers" class="text-primary"></i>
                </div>
                <div class="metric-trend">
                    <i data-lucide="trending-up" class="text-success"></i>
                </div>
            </div>
            <div class="metric-value" id="totalTasks">{{ queue_status.total_tasks }}</div>
            <div class="metric-label">Total Tasks</div>
            <div class="metric-progress mt-2">
                <div class="progress-bar" style="width: 75%"></div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card" data-metric="queued">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="metric-icon">
                    <i data-lucide="clock" class="text-warning"></i>
                </div>
                <div class="metric-trend">
                    <i data-lucide="trending-down" class="text-info"></i>
                </div>
            </div>
            <div class="metric-value" id="queuedTasks">{{ queue_status.queued_tasks }}</div>
            <div class="metric-label">Queued Tasks</div>
            <div class="metric-progress mt-2">
                <div class="progress-bar bg-warning" style="width: 45%"></div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card" data-metric="knowledge">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="metric-icon">
                    <i data-lucide="brain" class="text-success"></i>
                </div>
                <div class="metric-trend">
                    <i data-lucide="trending-up" class="text-success"></i>
                </div>
            </div>
            <div class="metric-value" id="knowledgeItems">{{ cache_stats.total_knowledge_cached }}</div>
            <div class="metric-label">Knowledge Items</div>
            <div class="metric-progress mt-2">
                <div class="progress-bar bg-success" style="width: 85%"></div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card" data-metric="cache">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="metric-icon">
                    <i data-lucide="zap" class="text-info"></i>
                </div>
                <div class="metric-trend">
                    <i data-lucide="trending-up" class="text-success"></i>
                </div>
            </div>
            <div class="metric-value" id="cacheHitRate">{{ "%.1f"|format(cache_stats.cache_hit_rate) }}%</div>
            <div class="metric-label">Cache Hit Rate</div>
            <div class="metric-progress mt-2">
                <div class="progress-bar bg-info" style="width: {{ cache_stats.cache_hit_rate }}%"></div>
            </div>
        </div>
    </div>
</div>

<!-- Status Overview -->
<div class="row mb-5 g-4">
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i data-lucide="pie-chart" class="me-2"></i>
                    <h5 class="mb-0">Task Status Distribution</h5>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshChart()">
                        <i data-lucide="refresh-cw"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleChartType()">
                        <i data-lucide="bar-chart-3"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container position-relative">
                    <canvas id="statusChart" width="400" height="200"></canvas>
                    <div class="chart-overlay" id="chartOverlay" style="display: none;">
                        <div class="loading-spinner"></div>
                        <span class="ms-2">Updating chart...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center">
                <i data-lucide="activity" class="me-2"></i>
                <h5 class="mb-0">System Status</h5>
            </div>
            <div class="card-body">
                <div class="status-item mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-medium">Processing Status</span>
                        <span class="status-badge {% if queue_status.is_processing %}status-processing{% else %}status-queued{% endif %}">
                            {% if queue_status.is_processing %}
                                <i data-lucide="loader" class="spinning"></i>
                                <span>Processing</span>
                            {% else %}
                                <i data-lucide="pause"></i>
                                <span>Idle</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="status-item mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-medium">Cache Size</span>
                        <span class="text-info fw-bold">{{ "%.2f"|format(cache_stats.database_size_mb) }} MB</span>
                    </div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-info" style="width: {{ (cache_stats.database_size_mb / 100) * 100 }}%"></div>
                    </div>
                </div>
                
                <div class="status-item mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-medium">Success Rate</span>
                        <span class="text-success fw-bold">
                            {% if queue_status.stats.total_tasks > 0 %}
                                {{ "%.1f"|format((queue_status.stats.completed_tasks / queue_status.stats.total_tasks) * 100) }}%
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                    </div>
                    <div class="progress" style="height: 4px;">
                        {% if queue_status.stats.total_tasks > 0 %}
                            <div class="progress-bar bg-success" style="width: {{ (queue_status.stats.completed_tasks / queue_status.stats.total_tasks) * 100 }}%"></div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="status-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-medium">Last Updated</span>
                        <span class="text-muted" id="lastUpdated">{{ datetime.now().strftime('%H:%M:%S') }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity & Quick Actions -->
<div class="row g-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i data-lucide="activity" class="me-2"></i>
                    <h5 class="mb-0">Recent Activity</h5>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="loadRecentActivity()">
                        <i data-lucide="refresh-cw"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleActivityView()">
                        <i data-lucide="list"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="recentActivity">
                    <div class="d-flex align-items-center justify-content-center p-4">
                        <div class="loading-spinner me-2"></div>
                        <span>Loading recent activity...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <i data-lucide="zap" class="me-2"></i>
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <button class="btn btn-primary d-flex align-items-center justify-content-center" onclick="showAddUrlModal()">
                        <i data-lucide="plus" class="me-2"></i>
                        <span>Add Single URL</span>
                    </button>
                    
                    <a href="/upload" class="btn btn-outline-primary d-flex align-items-center justify-content-center">
                        <i data-lucide="upload" class="me-2"></i>
                        <span>Batch Upload</span>
                    </a>
                    
                    <button class="btn btn-success d-flex align-items-center justify-content-center" onclick="startProcessing()">
                        <i data-lucide="play" class="me-2"></i>
                        <span>Start Processing</span>
                    </button>
                    
                    <button class="btn btn-outline-danger d-flex align-items-center justify-content-center" onclick="stopProcessing()">
                        <i data-lucide="square" class="me-2"></i>
                        <span>Stop Processing</span>
                    </button>
                    
                    <hr class="my-2">
                    
                    <a href="/knowledge" class="btn btn-outline-info d-flex align-items-center justify-content-center">
                        <i data-lucide="brain" class="me-2"></i>
                        <span>Browse Knowledge</span>
                    </a>
                    
                    <a href="/analytics" class="btn btn-outline-warning d-flex align-items-center justify-content-center">
                        <i data-lucide="bar-chart-3" class="me-2"></i>
                        <span>View Analytics</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Add URL Modal -->
<div class="modal fade" id="addUrlModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div class="d-flex align-items-center">
                    <i data-lucide="plus-circle" class="me-2 text-primary"></i>
                    <h5 class="modal-title mb-0">Add LinkedIn URL</h5>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUrlForm">
                    <div class="mb-4">
                        <label for="urlInput" class="form-label d-flex align-items-center">
                            <i data-lucide="link" class="me-2"></i>
                            LinkedIn URL
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i data-lucide="globe"></i>
                            </span>
                            <input type="url" class="form-control" id="urlInput" required
                                   placeholder="https://www.linkedin.com/posts/username/activity-id">
                        </div>
                        <div class="form-text">
                            <i data-lucide="info" class="me-1"></i>
                            Enter a valid LinkedIn post URL to extract knowledge
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="prioritySelect" class="form-label d-flex align-items-center">
                                    <i data-lucide="flag" class="me-2"></i>
                                    Priority Level
                                </label>
                                <select class="form-select" id="prioritySelect">
                                    <option value="1">ðŸŸ¢ Low Priority</option>
                                    <option value="3" selected>ðŸŸ¡ Normal Priority</option>
                                    <option value="5">ðŸŸ  High Priority</option>
                                    <option value="8">ðŸ”´ Urgent</option>
                                    <option value="10">âš¡ Critical</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoryHint" class="form-label d-flex align-items-center">
                                    <i data-lucide="tag" class="me-2"></i>
                                    Expected Category (Optional)
                                </label>
                                <select class="form-select" id="categoryHint">
                                    <option value="">Auto-detect</option>
                                    <option value="AI & Machine Learning">AI & Machine Learning</option>
                                    <option value="SaaS & Business">SaaS & Business</option>
                                    <option value="Marketing & Sales">Marketing & Sales</option>
                                    <option value="Leadership & Management">Leadership & Management</option>
                                    <option value="Technology Trends">Technology Trends</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notesInput" class="form-label d-flex align-items-center">
                            <i data-lucide="file-text" class="me-2"></i>
                            Notes (Optional)
                        </label>
                        <textarea class="form-control" id="notesInput" rows="3" 
                                  placeholder="Add any notes or context about this URL..."></textarea>
                    </div>
                    
                    <div class="alert alert-info d-flex align-items-start">
                        <i data-lucide="lightbulb" class="me-2 mt-1"></i>
                        <div>
                            <strong>Pro Tip:</strong> Higher priority tasks are processed first. 
                            Use critical priority only for time-sensitive content.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i data-lucide="x" class="me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="addUrl()">
                    <i data-lucide="plus" class="me-1"></i>Add to Queue
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .gradient-text {
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: rgba(59, 130, 246, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .metric-trend {
        opacity: 0.7;
    }
    
    .metric-progress {
        height: 4px;
        background: var(--border-primary);
        border-radius: 2px;
        overflow: hidden;
    }
    
    .metric-progress .progress-bar {
        height: 100%;
        background: var(--gradient-primary);
        border-radius: 2px;
        transition: width 0.8s ease;
    }
    
    .metric-progress .progress-bar.bg-warning {
        background: var(--gradient-warning);
    }
    
    .metric-progress .progress-bar.bg-success {
        background: var(--gradient-success);
    }
    
    .metric-progress .progress-bar.bg-info {
        background: var(--gradient-secondary);
    }
    
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    .chart-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(26, 26, 29, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        z-index: 10;
    }
    
    .status-item {
        padding: 1rem;
        border-radius: 0.75rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        transition: all var(--transition-normal);
    }
    
    .status-item:hover {
        background: var(--bg-hover);
        border-color: var(--border-secondary);
    }
    
    .spinning {
        animation: spin 1s linear infinite;
    }
    
    .activity-item {
        padding: 1rem;
        border-radius: 0.75rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        margin-bottom: 0.75rem;
        transition: all var(--transition-normal);
    }
    
    .activity-item:hover {
        background: var(--bg-hover);
        border-color: var(--border-secondary);
        transform: translateX(4px);
    }
    
    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
    }
    
    .activity-icon.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--accent-success);
    }
    
    .activity-icon.warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--accent-warning);
    }
    
    .activity-icon.info {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent-primary);
    }
    
    .activity-icon.danger {
        background: rgba(239, 68, 68, 0.1);
        color: var(--accent-danger);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let statusChart = null;
    let chartType = 'doughnut';
    let activityView = 'list';
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        initializeStatusChart();
        loadRecentActivity();
        animateMetrics();
        
        // Auto-refresh every 30 seconds
        setInterval(refreshDashboard, 30000);
        
        // Initialize real-time updates
        startRealTimeUpdates();
    });
    
    function initializeStatusChart() {
        const ctx = document.getElementById('statusChart').getContext('2d');
        const statusData = {{ queue_status.status_distribution | tojson }};
        
        const labels = Object.keys(statusData);
        const data = Object.values(statusData);
        
        // Modern color palette
        const colors = [
            '#3b82f6', // Blue
            '#f59e0b', // Amber
            '#10b981', // Emerald
            '#ef4444', // Red
            '#8b5cf6', // Violet
            '#06b6d4'  // Cyan
        ];
        
        const gradients = colors.map(color => {
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, color);
            gradient.addColorStop(1, color + '80');
            return gradient;
        });
        
        statusChart = new Chart(ctx, {
            type: chartType,
            data: {
                labels: labels.map(label => label.charAt(0).toUpperCase() + label.slice(1)),
                datasets: [{
                    data: data,
                    backgroundColor: gradients.slice(0, labels.length),
                    borderWidth: 0,
                    hoverBorderWidth: 3,
                    hoverBorderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            color: '#a1a1aa',
                            font: {
                                family: 'Inter',
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(26, 26, 29, 0.95)',
                        titleColor: '#ffffff',
                        bodyColor: '#a1a1aa',
                        borderColor: '#3f3f46',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${context.label}: ${context.parsed} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 1000,
                    easing: 'easeOutQuart'
                }
            }
        });
    }
    
    function animateMetrics() {
        // Animate metric values with counting effect
        gsap.utils.toArray('.metric-value').forEach((element, i) => {
            const finalValue = parseInt(element.textContent) || parseFloat(element.textContent) || 0;
            const isPercentage = element.textContent.includes('%');
            
            gsap.fromTo(element, {
                textContent: 0
            }, {
                textContent: finalValue,
                duration: 1.5,
                delay: i * 0.2,
                ease: "power2.out",
                snap: { textContent: isPercentage ? 0.1 : 1 },
                onUpdate: function() {
                    const current = parseFloat(this.targets()[0].textContent);
                    element.textContent = isPercentage ? 
                        current.toFixed(1) + '%' : 
                        Math.round(current).toLocaleString();
                }
            });
        });
        
        // Animate progress bars
        gsap.utils.toArray('.metric-progress .progress-bar').forEach((bar, i) => {
            const width = bar.style.width;
            gsap.fromTo(bar, {
                width: '0%'
            }, {
                width: width,
                duration: 1.2,
                delay: 0.5 + (i * 0.1),
                ease: "power2.out"
            });
        });
    }
    
    function refreshChart() {
        const overlay = document.getElementById('chartOverlay');
        overlay.style.display = 'flex';
        
        // Simulate chart refresh
        setTimeout(() => {
            overlay.style.display = 'none';
            
            // Add some animation to the chart
            statusChart.update('active');
            
            showAlert('Chart updated successfully!', 'success', 3000);
        }, 1500);
    }
    
    function toggleChartType() {
        chartType = chartType === 'doughnut' ? 'bar' : 'doughnut';
        
        // Animate chart transition
        gsap.to('#statusChart', {
            scale: 0.8,
            opacity: 0.5,
            duration: 0.3,
            onComplete: () => {
                statusChart.destroy();
                initializeStatusChart();
                
                gsap.to('#statusChart', {
                    scale: 1,
                    opacity: 1,
                    duration: 0.3
                });
            }
        });
    }
    
    async function loadRecentActivity() {
        try {
            showLoading('recentActivity', 'Loading activity...');
            
            // Simulate API calls for demo
            const [queueResponse, activityResponse] = await Promise.all([
                apiCall('/queue/status'),
                apiCall('/analytics/activity')
            ]);
            
            const activityHtml = generateActivityHtml(queueResponse, activityResponse);
            document.getElementById('recentActivity').innerHTML = activityHtml;
            
            // Animate activity items
            gsap.utils.toArray('.activity-item').forEach((item, i) => {
                gsap.fromTo(item, {
                    opacity: 0,
                    x: -20
                }, {
                    opacity: 1,
                    x: 0,
                    duration: 0.4,
                    delay: i * 0.1,
                    ease: "power2.out"
                });
            });
            
        } catch (error) {
            document.getElementById('recentActivity').innerHTML = 
                `<div class="alert alert-danger d-flex align-items-center">
                    <i data-lucide="alert-circle" class="me-2"></i>
                    <span>Failed to load recent activity</span>
                </div>`;
            lucide.createIcons();
        }
    }
    
    function generateActivityHtml(queueStatus, activityData) {
        if (queueStatus.total_tasks === 0) {
            return `
                <div class="text-center py-5">
                    <i data-lucide="inbox" class="mb-3" style="width: 48px; height: 48px; opacity: 0.5;"></i>
                    <p class="text-muted mb-0">No recent activity</p>
                    <small class="text-muted">Start processing URLs to see activity here</small>
                </div>
            `;
        }
        
        let html = '';
        
        // Processing status alert
        if (queueStatus.is_processing) {
            html += `
                <div class="alert alert-info d-flex align-items-center mb-4">
                    <div class="activity-icon info me-3">
                        <i data-lucide="loader" class="spinning"></i>
                    </div>
                    <div>
                        <strong>Processing Active</strong><br>
                        <small>Currently processing queue with ${queueStatus.queued_tasks} tasks remaining</small>
                    </div>
                </div>
            `;
        }
        
        // Recent activities
        const activities = [
            {
                type: 'success',
                icon: 'check-circle',
                title: 'Task Completed',
                description: 'Successfully extracted knowledge from AI business post',
                time: '2 minutes ago',
                details: 'Category: AI & Machine Learning'
            },
            {
                type: 'info',
                icon: 'plus-circle',
                title: 'New URL Added',
                description: 'LinkedIn post about SaaS growth strategies',
                time: '5 minutes ago',
                details: 'Priority: High'
            },
            {
                type: 'warning',
                icon: 'clock',
                title: 'Task Queued',
                description: 'Waiting for processing slot to become available',
                time: '8 minutes ago',
                details: 'Position: 3 in queue'
            },
            {
                type: 'success',
                icon: 'brain',
                title: 'Knowledge Extracted',
                description: 'New insights added to repository',
                time: '12 minutes ago',
                details: 'Topic: Digital Marketing Trends'
            }
        ];
        
        activities.forEach(activity => {
            html += `
                <div class="activity-item">
                    <div class="d-flex align-items-start">
                        <div class="activity-icon ${activity.type}">
                            <i data-lucide="${activity.icon}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <h6 class="mb-0">${activity.title}</h6>
                                <small class="text-muted">${activity.time}</small>
                            </div>
                            <p class="mb-1 text-secondary">${activity.description}</p>
                            <small class="text-muted">${activity.details}</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        return html;
    }
    
    function toggleActivityView() {
        activityView = activityView === 'list' ? 'grid' : 'list';
        loadRecentActivity();
    }
    
    function startRealTimeUpdates() {
        // Update metrics every 10 seconds
        setInterval(async () => {
            try {
                const response = await apiCall('/queue/status');
                updateMetricsRealTime(response);
                updateLastUpdatedTime();
            } catch (error) {
                console.error('Failed to update metrics:', error);
            }
        }, 10000);
    }
    
    function updateMetricsRealTime(queueStatus) {
        // Update metric values with animation
        const totalTasks = document.getElementById('totalTasks');
        const queuedTasks = document.getElementById('queuedTasks');
        const knowledgeItems = document.getElementById('knowledgeItems');
        const cacheHitRate = document.getElementById('cacheHitRate');
        
        if (totalTasks && totalTasks.textContent !== queueStatus.total_tasks.toString()) {
            animateValueChange(totalTasks, queueStatus.total_tasks);
        }
        
        if (queuedTasks && queuedTasks.textContent !== queueStatus.queued_tasks.toString()) {
            animateValueChange(queuedTasks, queueStatus.queued_tasks);
        }
    }
    
    function animateValueChange(element, newValue) {
        const currentValue = parseInt(element.textContent) || 0;
        
        gsap.to(element, {
            textContent: newValue,
            duration: 0.8,
            ease: "power2.out",
            snap: { textContent: 1 },
            onUpdate: function() {
                element.textContent = Math.round(this.targets()[0].textContent).toLocaleString();
            }
        });
        
        // Add glow effect
        gsap.to(element.parentElement, {
            boxShadow: "0 0 20px rgba(59, 130, 246, 0.3)",
            duration: 0.3,
            yoyo: true,
            repeat: 1
        });
    }
    
    function updateLastUpdatedTime() {
        const lastUpdated = document.getElementById('lastUpdated');
        if (lastUpdated) {
            lastUpdated.textContent = new Date().toLocaleTimeString();
        }
    }
    
    function showAddUrlModal() {
        const modal = new bootstrap.Modal(document.getElementById('addUrlModal'));
        modal.show();
        
        // Animate modal content
        setTimeout(() => {
            gsap.fromTo('.modal-content', {
                scale: 0.9,
                opacity: 0
            }, {
                scale: 1,
                opacity: 1,
                duration: 0.3,
                ease: "back.out(1.7)"
            });
        }, 100);
        
        // Initialize icons
        lucide.createIcons();
    }
    
    async function addUrl() {
        const url = document.getElementById('urlInput').value;
        const priority = parseInt(document.getElementById('prioritySelect').value);
        const categoryHint = document.getElementById('categoryHint').value;
        const notes = document.getElementById('notesInput').value;
        
        if (!url) {
            showAlert('Please enter a URL', 'warning');
            return;
        }
        
        if (!url.includes('linkedin.com')) {
            showAlert('Please enter a valid LinkedIn URL', 'warning');
            return;
        }
        
        try {
            // Show loading state
            const addButton = document.querySelector('#addUrlModal .btn-primary');
            const originalText = addButton.innerHTML;
            addButton.innerHTML = '<div class="loading-spinner me-2"></div>Adding...';
            addButton.disabled = true;
            
            const response = await apiCall('/urls/add', 'POST', {
                url: url,
                priority: priority,
                category_hint: categoryHint,
                notes: notes,
                metadata: { 
                    source: 'web_interface',
                    timestamp: new Date().toISOString()
                }
            });
            
            showAlert(`âœ… URL added successfully! Task ID: ${response.task_id}`, 'success');
            
            // Close modal with animation
            gsap.to('.modal-content', {
                scale: 0.9,
                opacity: 0,
                duration: 0.2,
                ease: "power2.in",
                onComplete: () => {
                    bootstrap.Modal.getInstance(document.getElementById('addUrlModal')).hide();
                    document.getElementById('addUrlForm').reset();
                }
            });
            
            // Refresh dashboard after delay
            setTimeout(() => {
                refreshDashboard();
            }, 1000);
            
        } catch (error) {
            // Reset button state
            const addButton = document.querySelector('#addUrlModal .btn-primary');
            addButton.innerHTML = originalText;
            addButton.disabled = false;
        }
    }
    
    async function startProcessing() {
        try {
            const button = event.target;
            const originalText = button.innerHTML;
            
            // Animate button
            button.innerHTML = '<div class="loading-spinner me-2"></div>Starting...';
            button.disabled = true;
            
            const response = await apiCall('/process/start', 'POST', {
                max_concurrent: 3
            });
            
            showAlert(`ðŸš€ ${response.message}`, 'success');
            
            // Start polling for updates
            startProgressPolling();
            
            // Reset button after delay
            setTimeout(() => {
                button.innerHTML = '<i data-lucide="square" class="me-2"></i>Stop Processing';
                button.className = 'btn btn-outline-danger d-flex align-items-center justify-content-center';
                button.disabled = false;
                button.onclick = stopProcessing;
                lucide.createIcons();
            }, 2000);
            
        } catch (error) {
            // Reset button state
            const button = event.target;
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }
    
    async function stopProcessing() {
        try {
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<div class="loading-spinner me-2"></div>Stopping...';
            button.disabled = true;
            
            const response = await apiCall('/process/stop', 'POST');
            
            showAlert(`â¹ï¸ ${response.message}`, 'info');
            
            // Reset button
            setTimeout(() => {
                button.innerHTML = '<i data-lucide="play" class="me-2"></i>Start Processing';
                button.className = 'btn btn-success d-flex align-items-center justify-content-center';
                button.disabled = false;
                button.onclick = startProcessing;
                lucide.createIcons();
            }, 1000);
            
        } catch (error) {
            // Reset button state
            const button = event.target;
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }
    
    function startProgressPolling() {
        const pollInterval = setInterval(async () => {
            try {
                const status = await apiCall('/queue/status');
                
                if (!status.is_processing) {
                    clearInterval(pollInterval);
                    showAlert('âœ… Processing completed!', 'success');
                    
                    // Refresh with animation
                    gsap.to('body', {
                        opacity: 0.8,
                        duration: 0.3,
                        onComplete: () => {
                            refreshDashboard();
                        }
                    });
                }
                
                // Update progress display
                updateProgressDisplay(status);
                
            } catch (error) {
                clearInterval(pollInterval);
            }
        }, 2000);
    }
    
    function updateProgressDisplay(status) {
        const stats = status.stats;
        const total = stats.total_tasks;
        const completed = stats.completed_tasks;
        
        if (total > 0) {
            const percentage = (completed / total) * 100;
            
            // Update any progress indicators
            const progressBars = document.querySelectorAll('.metric-progress .progress-bar');
            progressBars.forEach(bar => {
                gsap.to(bar, {
                    width: `${percentage}%`,
                    duration: 0.5,
                    ease: "power2.out"
                });
            });
        }
    }
    
    function refreshDashboard() {
        // Animate refresh
        gsap.to('.main-content', {
            y: -20,
            opacity: 0.5,
            duration: 0.3,
            onComplete: () => {
                location.reload();
            }
        });
    }
</script>
{% endblock %}