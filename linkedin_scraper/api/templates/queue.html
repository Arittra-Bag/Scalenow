{% extends "base.html" %}

{% block title %}Processing Queue - LinkedIn Knowledge Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="fas fa-list me-2"></i>Processing Queue
    </h1>
    <div>
        <button class="btn btn-outline-secondary me-2" onclick="refreshQueue()">
            <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
        <button class="btn btn-success" onclick="startProcessing()" id="startBtn">
            <i class="fas fa-play me-1"></i>Start Processing
        </button>
        <button class="btn btn-warning" onclick="stopProcessing()" id="stopBtn" style="display: none;">
            <i class="fas fa-stop me-1"></i>Stop Processing
        </button>
    </div>
</div>

<!-- Queue Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-value" id="totalTasks">0</div>
            <div class="metric-label">Total Tasks</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-value" id="queuedTasks">0</div>
            <div class="metric-label">Queued</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-value" id="completedTasks">0</div>
            <div class="metric-label">Completed</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-value" id="failedTasks">0</div>
            <div class="metric-label">Failed</div>
        </div>
    </div>
</div>

<!-- Processing Status -->
<div class="row mb-4" id="processingStatus" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="loading-spinner me-3"></div>
                    <div>
                        <h5 class="mb-1">Processing in Progress</h5>
                        <p class="mb-0 text-muted" id="processingMessage">Processing queue...</p>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="progress progress-custom">
                        <div class="progress-bar progress-bar-custom" role="progressbar" 
                             style="width: 0%" id="progressBar">
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-muted">Progress</small>
                        <small class="text-muted" id="progressText">0 / 0 (0%)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Task List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>Task List
                    </h5>
                    <div>
                        <select class="form-select form-select-sm" id="statusFilter" onchange="filterTasks()">
                            <option value="all">All Status</option>
                            <option value="queued">Queued</option>
                            <option value="processing">Processing</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                            <option value="retrying">Retrying</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="taskList">
                    <div class="text-center p-4">
                        <i class="fas fa-spinner fa-spin me-2"></i>Loading tasks...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Task Details Modal -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Task Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="taskDetailsContent">
                <!-- Task details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="cancelTaskBtn" onclick="cancelCurrentTask()" style="display: none;">
                    <i class="fas fa-times me-1"></i>Cancel Task
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentTaskId = null;
    let taskListData = [];
    let isProcessing = false;
    let refreshInterval = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        loadTaskList();
        checkProcessingStatus();
    });
    
    async function loadTaskList() {
        try {
            const response = await apiCall('/queue/status');
            taskListData = response.tasks || [];
            updateQueueStats(response);
            renderTaskList(taskListData);
        } catch (error) {
            document.getElementById('taskList').innerHTML = 
                '<div class="text-danger p-4 text-center">Failed to load tasks</div>';
        }
    }
    
    function updateQueueStats(queueData) {
        document.getElementById('totalTasks').textContent = queueData.total_tasks || 0;
        document.getElementById('queuedTasks').textContent = queueData.queued_tasks || 0;
        document.getElementById('completedTasks').textContent = queueData.completed_tasks || 0;
        document.getElementById('failedTasks').textContent = queueData.failed_tasks || 0;
        
        // Update processing status
        isProcessing = queueData.is_processing || false;
        updateProcessingUI();
        
        if (isProcessing && queueData.total_tasks > 0) {
            const progress = ((queueData.completed_tasks + queueData.failed_tasks) / queueData.total_tasks) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                `${queueData.completed_tasks + queueData.failed_tasks} / ${queueData.total_tasks} (${Math.round(progress)}%)`;
            document.getElementById('processingMessage').textContent = 
                `Processing queue with ${queueData.queued_tasks} tasks remaining`;
        }
    }
    
    function updateProcessingUI() {
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const processingStatus = document.getElementById('processingStatus');
        
        if (isProcessing) {
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            processingStatus.style.display = 'block';
            
            // Start auto-refresh
            if (!refreshInterval) {
                refreshInterval = setInterval(loadTaskList, 5000);
            }
        } else {
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            processingStatus.style.display = 'none';
            
            // Stop auto-refresh
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
    }
    
    function renderTaskList(tasks) {
        const taskListElement = document.getElementById('taskList');
        
        if (!tasks || tasks.length === 0) {
            taskListElement.innerHTML = 
                '<div class="text-muted p-4 text-center">No tasks in queue</div>';
            return;
        }
        
        let html = '<div class="table-responsive">';
        html += '<table class="table table-hover mb-0">';
        html += `
            <thead class="table-dark">
                <tr>
                    <th>Task ID</th>
                    <th>URL</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        tasks.forEach(task => {
            const shortUrl = task.url.length > 50 ? task.url.substring(0, 50) + '...' : task.url;
            const priorityText = getPriorityText(task.priority);
            const statusBadge = `<span class="status-badge ${getStatusBadgeClass(task.status)}">${task.status}</span>`;
            
            html += `
                <tr class="task-row" data-status="${task.status}">
                    <td><code>${task.id}</code></td>
                    <td>
                        <a href="${task.url}" target="_blank" class="text-decoration-none" title="${task.url}">
                            ${shortUrl}
                        </a>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${priorityText}</span>
                    </td>
                    <td>${statusBadge}</td>
                    <td>${formatDate(task.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showTaskDetails('${task.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${task.status === 'queued' || task.status === 'retrying' ? 
                            `<button class="btn btn-sm btn-outline-danger ms-1" onclick="cancelTask('${task.id}')">
                                <i class="fas fa-times"></i>
                            </button>` : ''}
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        taskListElement.innerHTML = html;
    }
    
    function getPriorityText(priority) {
        const priorities = {
            1: 'Low',
            3: 'Normal', 
            5: 'High',
            8: 'Urgent',
            10: 'Critical'
        };
        return priorities[priority] || 'Normal';
    }
    
    function filterTasks() {
        const filter = document.getElementById('statusFilter').value;
        const rows = document.querySelectorAll('.task-row');
        
        rows.forEach(row => {
            const status = row.getAttribute('data-status');
            if (filter === 'all' || status === filter) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    async function showTaskDetails(taskId) {
        try {
            currentTaskId = taskId;
            const task = await apiCall(`/tasks/${taskId}`);
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Task ID:</strong></td><td><code>${task.id}</code></td></tr>
                            <tr><td><strong>Status:</strong></td><td><span class="status-badge ${getStatusBadgeClass(task.status)}">${task.status}</span></td></tr>
                            <tr><td><strong>Priority:</strong></td><td>${getPriorityText(task.priority)}</td></tr>
                            <tr><td><strong>Retry Count:</strong></td><td>${task.retry_count || 0}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Timing</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Created:</strong></td><td>${formatDate(task.created_at)}</td></tr>
                            <tr><td><strong>Started:</strong></td><td>${formatDate(task.started_at)}</td></tr>
                            <tr><td><strong>Completed:</strong></td><td>${formatDate(task.completed_at)}</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>URL</h6>
                        <div class="bg-light p-2 rounded">
                            <a href="${task.url}" target="_blank" class="text-break">${task.url}</a>
                        </div>
                    </div>
                </div>
            `;
            
            if (task.error_message) {
                html += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Error Message</h6>
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                ${task.error_message}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (task.result) {
                html += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Result</h6>
                            <pre class="bg-light p-2 rounded"><code>${JSON.stringify(task.result, null, 2)}</code></pre>
                        </div>
                    </div>
                `;
            }
            
            if (task.metadata) {
                html += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Metadata</h6>
                            <pre class="bg-light p-2 rounded"><code>${JSON.stringify(task.metadata, null, 2)}</code></pre>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('taskDetailsContent').innerHTML = html;
            
            // Show cancel button if task can be cancelled
            const cancelBtn = document.getElementById('cancelTaskBtn');
            if (task.status === 'queued' || task.status === 'retrying') {
                cancelBtn.style.display = 'inline-block';
            } else {
                cancelBtn.style.display = 'none';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('taskDetailsModal'));
            modal.show();
            
        } catch (error) {
            showAlert('Failed to load task details', 'danger');
        }
    }
    
    async function cancelTask(taskId) {
        if (!confirm('Are you sure you want to cancel this task?')) {
            return;
        }
        
        try {
            await apiCall(`/tasks/${taskId}`, 'DELETE');
            showAlert('Task cancelled successfully', 'success');
            loadTaskList();
        } catch (error) {
            // Error already shown by apiCall
        }
    }
    
    async function cancelCurrentTask() {
        if (currentTaskId) {
            await cancelTask(currentTaskId);
            bootstrap.Modal.getInstance(document.getElementById('taskDetailsModal')).hide();
        }
    }
    
    async function startProcessing() {
        try {
            const response = await apiCall('/process/start', 'POST', {
                max_concurrent: 3
            });
            
            showAlert(response.message || 'Processing started', 'success');
            setTimeout(loadTaskList, 1000);
            
        } catch (error) {
            // Error already shown by apiCall
        }
    }
    
    async function stopProcessing() {
        try {
            const response = await apiCall('/process/stop', 'POST');
            showAlert(response.message || 'Processing stopped', 'warning');
            setTimeout(loadTaskList, 1000);
            
        } catch (error) {
            // Error already shown by apiCall
        }
    }
    
    async function checkProcessingStatus() {
        try {
            const response = await apiCall('/process/status');
            isProcessing = response.is_processing || false;
            updateProcessingUI();
        } catch (error) {
            // Silently fail - this is just for UI state
        }
    }
    
    function refreshQueue() {
        loadTaskList();
    }
    
    // Cleanup interval on page unload
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
</script>
{% endblock %}